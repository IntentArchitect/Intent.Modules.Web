<form #form="ngForm" novalidate (ngSubmit)="onSave(form)">
    <h2 mat-dialog-title>Edit Customer</h2>

    <mat-dialog-content class="dialog-content">
        <ng-container *ngIf="model; else loadingTpl">
            <div class="grid">
                <div class="grid-item">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Name</mat-label>
                        <input matInput
                               required
                               name="name"
                               [(ngModel)]="model!.name"
                               #nameCtrl="ngModel" />
                        <mat-error *ngIf="nameCtrl.invalid && (nameCtrl.touched || form.submitted)">
                            Name is required
                        </mat-error>
                    </mat-form-field>
                </div>

                <div class="grid-item">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Surname</mat-label>
                        <input matInput
                               required
                               name="surname"
                               [(ngModel)]="model!.surname"
                               #surnameCtrl="ngModel" />
                        <mat-error *ngIf="surnameCtrl.invalid && (surnameCtrl.touched || form.submitted)">
                            Surname is required
                        </mat-error>
                    </mat-form-field>
                </div>

                <div class="grid-item">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Email</mat-label>
                        <input matInput
                               required
                               email
                               name="email"
                               [(ngModel)]="model!.email"
                               #emailCtrl="ngModel" />
                        <mat-error *ngIf="emailCtrl.hasError('required') && (emailCtrl.touched || form.submitted)">
                            Email is required
                        </mat-error>
                        <mat-error *ngIf="emailCtrl.hasError('email') && !emailCtrl.hasError('required') && (emailCtrl.touched || form.submitted)">
                            Please enter a valid email
                        </mat-error>
                    </mat-form-field>
                </div>

                <div class="grid-item">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Category</mat-label>
                        <mat-select required
                                    name="categoryId"
                                    [(ngModel)]="model!.categoryId"
                                    #categoryCtrl="ngModel"
                                    (selectionChange)="onCategoryChange($event.value)">
                            <mat-option [value]="null">Select...</mat-option>
                            <mat-option *ngFor="let c of categoriesModels" [value]="c.id">
                                {{ c.name }}
                            </mat-option>
                        </mat-select>
                        <mat-error *ngIf="categoryCtrl.invalid && (categoryCtrl.touched || form.submitted)">
                            Category is required
                        </mat-error>
                    </mat-form-field>
                </div>

                <div class="grid-item">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Sub Category</mat-label>
                        <mat-select required
                                    name="subCategoryId"
                                    [(ngModel)]="model!.subCategoryId"
                                    #subCategoryCtrl="ngModel">
                            <mat-option [value]="null">Select...</mat-option>
                            <mat-option *ngFor="let s of subCategoriesModels" [value]="s.id">
                                {{ s.name }}
                            </mat-option>
                        </mat-select>
                        <mat-error *ngIf="subCategoryCtrl.invalid && (subCategoryCtrl.touched || form.submitted)">
                            Sub category is required
                        </mat-error>
                    </mat-form-field>
                </div>

                <div class="grid-item">
                    <mat-slide-toggle color="primary"
                                      name="isActive"
                                      [(ngModel)]="model!.isActive">
                        Active
                    </mat-slide-toggle>
                </div>

                <div class="grid-item-wide">
                    <h3 class="section-title">Preferences</h3>
                </div>

                <div class="grid-item">
                    <mat-slide-toggle color="primary"
                                      name="newsLetter"
                                      [(ngModel)]="model!.preference.newsLetter">
                        Subscribe to Newsletter
                    </mat-slide-toggle>
                </div>

                <div class="grid-item">
                    <mat-slide-toggle color="primary"
                                      name="specials"
                                      [(ngModel)]="model!.preference.specials">
                        Receive Specials
                    </mat-slide-toggle>
                </div>

                <div class="grid-item-wide">
                    <div class="loyalty-header">
                        <h3 class="section-title">Loyalty</h3>
                        <mat-slide-toggle color="primary"
                                          [checked]="hasLoyalty"
                                          (change)="onHasLoyaltyChange($event.checked)">
                            Has Loyalty
                        </mat-slide-toggle>
                    </div>
                </div>

                <ng-container *ngIf="hasLoyalty && model?.loyalty">
                    <div class="grid-item">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Loyalty Number</mat-label>
                            <input matInput
                                   required
                                   name="loyaltyNo"
                                   [(ngModel)]="model!.loyalty!.loyaltyNo"
                                   #loyaltyNoCtrl="ngModel" />
                            <mat-error *ngIf="loyaltyNoCtrl.invalid && (loyaltyNoCtrl.touched || form.submitted)">
                                Loyalty number is required
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <div class="grid-item">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Points</mat-label>
                            <input matInput
                                   type="number"
                                   min="0"
                                   name="points"
                                   [(ngModel)]="model!.loyalty!.points" />
                        </mat-form-field>
                    </div>
                </ng-container>

                <div class="grid-item-wide">
                    <h3 class="section-title">Addresses</h3>
                </div>

                <ng-container *ngFor="let addr of model!.addresses; let i = index">
                    <div class="grid-item-wide address-block">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Type</mat-label>
                            <mat-select name="addressType{{ i }}"
                                        [(ngModel)]="addr.addressType">
                                <mat-option [value]="AddressType.Deliver">Delivery</mat-option>
                                <mat-option [value]="AddressType.Billing">Billing</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Address line 1</mat-label>
                            <input matInput
                                   required
                                   name="line1{{ i }}"
                                   [(ngModel)]="addr.line1"
                                   #line1Ctrl="ngModel" />
                            <mat-error *ngIf="line1Ctrl.invalid && (line1Ctrl.touched || form.submitted)">
                                Line 1 is required
                            </mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Address line 2</mat-label>
                            <input matInput
                                   name="line2{{ i }}"
                                   [(ngModel)]="addr.line2" />
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>City</mat-label>
                            <input matInput
                                   required
                                   name="city{{ i }}"
                                   [(ngModel)]="addr.city"
                                   #cityCtrl="ngModel" />
                            <mat-error *ngIf="cityCtrl.invalid && (cityCtrl.touched || form.submitted)">
                                City is required
                            </mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Postal code</mat-label>
                            <input matInput
                                   required
                                   name="postal{{ i }}"
                                   [(ngModel)]="addr.postal"
                                   #postalCtrl="ngModel" />
                            <mat-error *ngIf="postalCtrl.invalid && (postalCtrl.touched || form.submitted)">
                                Postal code is required
                            </mat-error>
                        </mat-form-field>

                        <button mat-stroked-button
                                color="warn"
                                type="button"
                                class="remove-btn"
                                (click)="removeAddress(i)">
                            Remove
                        </button>
                    </div>
                </ng-container>

                <div class="grid-item-wide">
                    <button mat-stroked-button
                            color="primary"
                            type="button"
                            (click)="addAddress()">
                        Add address
                    </button>
                </div>

                <div class="grid-item-wide error-text" *ngIf="serviceErrors.updateCustomerError">
                    {{ serviceErrors.updateCustomerError }}
                </div>
            </div>
        </ng-container>

        <ng-template #loadingTpl>
            <div class="loading-container">
                <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
                <div class="mt-2">Loading customer...</div>
            </div>
        </ng-template>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
        <button mat-button type="button" (click)="cancel()">
            Cancel
        </button>

        <button mat-raised-button
                color="primary"
                type="submit"
                [disabled]="form.invalid || isLoading || !model">
            <mat-progress-spinner *ngIf="isLoading"
                                  mode="indeterminate"
                                  diameter="18"
                                  class="spinner">
            </mat-progress-spinner>
            <span *ngIf="!isLoading">Save</span>
        </button>
    </mat-dialog-actions>
</form>
